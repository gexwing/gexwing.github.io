<!DOCTYPE html>
<html>
<head>
  <title>Fretboard Chord Visualizer</title>
  <script type="text/javascript" src="music-data.js"></script>
  <script type="text/javascript" src="cFretboard.js"></script>
  <script type="text/javascript">

    function populateFormElements() {
      let params = new URLSearchParams(window.location.search.slice(1));

      function popHelper(selectid, dataarray)
      {
        let select = document.getElementById(selectid);
        dataarray.forEach(option => {
          let optionelement = document.createElement('option');
          optionelement.value = option;
          optionelement.innerHTML = option;
          if (params.get(selectid) == option) { optionelement.selected = true; }
          select.appendChild(optionelement);
        });
      };

      popHelper("tuning", Object.keys(tunings));

      popHelper("key", notesNames);
      popHelper("scale", Object.keys(scales));

      popHelper("rootnote", notesNames);
      popHelper("chord", Object.keys(chords_basic));
      popHelper("chord", Object.keys(chords_sus));
      popHelper("chord", Object.keys(chords_7th));
    };
  
    function prepare()
    {
      populateFormElements();
      quickchordsUpdate();
      update();
    }

    function update()
    {
      let canvas = document.getElementById('cFretboard');
      let strings = tunings[document.getElementById("tuning").value];
      let root = document.getElementById("rootnote").selectedIndex;
      let notes = chords_all[document.getElementById("chord").value].map(
        note => (note + root) % 12
      );

      cFretDraw(canvas, strings, notes);
    }

    function quickchordsUpdate()
    {
      let keyoffset = document.getElementById("key").selectedIndex;
      let notes = scales[document.getElementById("scale").value];

      document.getElementById('quickchords_basic').innerText = null;
      document.getElementById('quickchords_sus').innerText = null;
      document.getElementById('quickchords_7th').innerText = null;

      for ([root, cname] of findChords(chords_basic, notes.map(note => (note + keyoffset) % 12)))
      {
        let option = document.createElement("option");
        option.innerHTML = notesNames[root] + cname;
        option.dataset.root = root;
        option.dataset.cname = cname;
        document.getElementById("quickchords_basic").appendChild(option);
      }
      for ([root, cname] of findChords(chords_sus, notes.map(note => (note + keyoffset) % 12)))
      {
        let option = document.createElement("option");
        option.innerHTML = notesNames[root] + cname;
        option.dataset.root = root;
        option.dataset.cname = cname;
        document.getElementById("quickchords_sus").appendChild(option);
      }
      for ([root, cname] of findChords(chords_7th, notes.map(note => (note + keyoffset) % 12)))
      {
        let option = document.createElement("option");
        option.innerHTML = notesNames[root] + cname;
        option.dataset.root = root;
        option.dataset.cname = cname;
        document.getElementById("quickchords_7th").appendChild(option);
      }
    }
  
    function quickchordSelected(obj)
    {
      let opt_root = document.querySelector('select#rootnote [value="' + notesNames[obj.options[obj.selectedIndex].dataset.root] + '"]');
      let opt_cname = document.querySelector('select#chord [value="' + obj.options[obj.selectedIndex].dataset.cname + '"]');

      if ((opt_root) && (opt_cname))
      {
        opt_root.selected = true;
        opt_cname.selected = true;
        update();
      }
    }

  </script>
  
  <style type="text/css">
    canvas { border: 1px solid black; }
    form div { width: 300px; }
    div select { width: 100%; }
  </style>

</head>

<body onload="prepare();">
  <form id="ChordForm" method="get">
    <div style="float: left;">
      <select name="key" id="key" onchange="quickchordsUpdate();"></select>
      <select name="scale" id="scale" onchange="quickchordsUpdate();"></select>
    </div>

    <div>
      <select size=8 onchange="quickchordSelected(this);";>
        <!-- <option></option> -->
        <optgroup id="quickchords_basic" label="Basic Chords"></optgroup>
        <optgroup id="quickchords_sus" label="Sus Chords"></optgroup>
        <optgroup id="quickchords_7th" label="7th Chords"></optgroup>
      </select>
    </div>

    <br />

    <div>
      <select name="rootnote" id="rootnote" onchange="update();"></select>
      <select name="chord" id="chord" onchange="update();"></select>
    </div>

    <div>
      <select name="tuning" id="tuning" onchange="update();"></select>
    </div>
    
  </form>
  <canvas id="cFretboard"></canvas>
</body>
</html>
